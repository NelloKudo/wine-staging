From d92d2f9dab7aa9552dbed099a3f07182c8bad185 Mon Sep 17 00:00:00 2001
From: Alistair Leslie-Hughes <leslie_alistair@hotmail.com>
Date: Wed, 10 Jul 2024 15:17:00 +1000
Subject: [PATCH] odbc32: Store handles when requesting information of Columns.

---
 dlls/odbc32/proxyodbc.c | 34 +++++++++++++++++++++++++++++++++-
 dlls/odbc32/unixlib.h   | 11 +++++++++++
 2 files changed, 44 insertions(+), 1 deletion(-)

diff --git a/dlls/odbc32/proxyodbc.c b/dlls/odbc32/proxyodbc.c
index dd94e070796..7120f24b76b 100644
--- a/dlls/odbc32/proxyodbc.c
+++ b/dlls/odbc32/proxyodbc.c
@@ -6105,7 +6105,39 @@ SQLRETURN WINAPI SQLGetStmtAttrW(SQLHSTMT StatementHandle, SQLINTEGER Attribute,
     }
     else if (handle->win32_handle)
     {
-        ret = get_stmt_attr_win32_w( handle, Attribute, Value, BufferLength, StringLength );
+         switch(Attribute)
+        {
+            case SQL_ATTR_APP_ROW_DESC:
+                handle->app_row_desc.parent = handle;
+                ret = handle->win32_funcs->SQLGetStmtAttrW( handle->win32_handle, Attribute,
+                                                             &handle->app_row_desc.driver_hdesc,
+                                                             BufferLength, StringLength);
+                *((SQLHDESC*)Value) = &handle->app_row_desc;
+                break;
+            case SQL_ATTR_IMP_ROW_DESC:
+                handle->imp_row_desc.parent = handle;
+                ret = handle->win32_funcs->SQLGetStmtAttrW( handle->win32_handle, Attribute,
+                                                             &handle->imp_row_desc.driver_hdesc,
+                                                             BufferLength, StringLength);
+                *((SQLHDESC*)Value) = &handle->imp_row_desc;
+                break;
+            case SQL_ATTR_APP_PARAM_DESC:
+                handle->app_param_desc.parent = handle;
+                ret = handle->win32_funcs->SQLGetStmtAttrW( handle->win32_handle, Attribute,
+                                                             &handle->app_param_desc.driver_hdesc,
+                                                             BufferLength, StringLength);
+                *((SQLHDESC*)Value) = &handle->app_param_desc;
+                break;
+            case SQL_ATTR_IMP_PARAM_DESC:
+                handle->imp_param_desc.parent = handle;
+                ret = handle->win32_funcs->SQLGetStmtAttrW( handle->win32_handle, Attribute,
+                                                             &handle->imp_param_desc.driver_hdesc,
+                                                             BufferLength, StringLength);
+                *((SQLHDESC*)Value) = &handle->imp_param_desc;
+                break;
+            default:
+                ret = get_stmt_attr_win32_w( handle, Attribute, Value, BufferLength, StringLength );
+        }
     }
 
     TRACE("Returning %d\n", ret);
diff --git a/dlls/odbc32/unixlib.h b/dlls/odbc32/unixlib.h
index 4241d06c892..fc69857c8b7 100644
--- a/dlls/odbc32/unixlib.h
+++ b/dlls/odbc32/unixlib.h
@@ -183,6 +183,12 @@ struct param_binding
     struct param *param;
 };
 
+struct SQLHDESC_data
+{
+    struct handle *parent;
+    SQLHDESC driver_hdesc;
+};
+
 struct handle
 {
     /* handles */
@@ -194,6 +200,11 @@ struct handle
     UINT32 env_attr_version;
     UINT32 con_attr_con_timeout;
     UINT32 con_attr_login_timeout;
+    /* statement parameters */
+    struct SQLHDESC_data app_row_desc;
+    struct SQLHDESC_data imp_row_desc;
+    struct SQLHDESC_data app_param_desc;
+    struct SQLHDESC_data imp_param_desc;
     /* drivers and data sources */
     UINT32 drivers_idx;
     void  *drivers_key;
-- 
2.43.0

